name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  actions: read
  contents: read
  security-events: write

jobs:
  test:
    runs-on: ubuntu-latest

    env:
      PHP_CS_FIXER_IGNORE_ENV: 1

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: pdo_mysql, mbstring, exif, pcntl, bcmath, gd, zip, intl, opcache, redis
        tools: composer:v2

    - name: Cache Composer dependencies
      uses: actions/cache@v3
      with:
        path: vendor
        key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
        restore-keys: |
          ${{ runner.os }}-composer-

    - name: Install Composer dependencies
      run: composer install --no-progress --prefer-dist --optimize-autoloader

    - name: Install Node dependencies
      run: npm install

    - name: Build assets
      run: npm run build

    - name: Setup Laravel environment
      run: |
        echo "APP_NAME=Smarthr" > .env
        echo "APP_ENV=testing" >> .env
        echo "APP_KEY=base64:$(openssl rand -base64 32)" >> .env
        echo "DB_CONNECTION=sqlite" >> .env
        echo "DB_DATABASE=:memory:" >> .env
        echo "CACHE_DRIVER=array" >> .env
        echo "SESSION_DRIVER=array" >> .env
        echo "QUEUE_CONNECTION=sync" >> .env

    - name: Run PHPUnit
      run: ./vendor/bin/phpunit

    - name: Build Backend Docker Image
      run: docker build -t backend -f Dockerfiles/app/backend/Dockerfile .

    - name: Build Frontend Docker Image
      run: docker build -t frontend -f Dockerfiles/app/frontend/Dockerfile .

    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v4
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

  dependency-check:
    name: OWASP Dependency-Check
    runs-on: ubuntu-latest
    needs: test
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Create report directory
      run: mkdir -p dependency-check-report

    - name: Run OWASP Dependency-Check (Docker)
      run: |
        docker run --rm \
          -v "${{ github.workspace }}:/src" \
          -v "${{ github.workspace }}/dependency-check-report:/report" \
          owasp/dependency-check:latest \
          --project "smartRH" \
          --scan /src \
          --format ALL \
          --out /report

    - name: Upload Dependency-Check report
      uses: actions/upload-artifact@v4
      with:
        name: dependency-check-report
        path: dependency-check-report

    - name: Convert JSON to SARIF (optional)
      run: |
        if [ -f dependency-check-report/dependency-check-report.json ]; then
          jq -n --argfile d dependency-check-report/dependency-check-report.json '{version: "2.1.0", runs: [$d]}' > dependency-check.sarif || true
        fi

    - name: Upload SARIF
      if: always()
      uses: github/codeql-action/upload-sarif@v4
      with:
        sarif_file: 'dependency-check.sarif'

  deploy:
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: staging
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Build and Push Backend Image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfiles/app/backend/Dockerfile
        push: true
        tags: ${{ secrets.DOCKER_USERNAME }}/smarthr-backend:${{ github.sha }}, ${{ secrets.DOCKER_USERNAME }}/smarthr-backend:latest

    - name: Build and Push Frontend Image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfiles/app/frontend/Dockerfile
        push: true
        tags: ${{ secrets.DOCKER_USERNAME }}/smarthr-frontend:${{ github.sha }}, ${{ secrets.DOCKER_USERNAME }}/smarthr-frontend:latest

    - name: Build and Push Database Image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfiles/db/Dockerfile
        push: true
        tags: ${{ secrets.DOCKER_USERNAME }}/smarthr-db:${{ github.sha }}, ${{ secrets.DOCKER_USERNAME }}/smarthr-db:latest
        
    - name: Build and Push web Image
      uses: docker/build-push-action@v5
      with:
          context: .
          file: ./Dockerfiles/web/Dockerfile
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/smarthr-web:${{ github.sha }}, ${{ secrets.DOCKER_USERNAME }}/smarthr-web:latest